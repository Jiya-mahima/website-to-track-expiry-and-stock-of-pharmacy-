<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expiry - PharmaWise</title>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">


  <style>
    :root{
      --sidebar-w:300px;
      --brand-dark:#0b214a;
      --brand-green:#0b8f75;
      --muted:#f4f6f8;
      --accent:#fcd34d;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--muted);color:#222}

    /* Sidebar */
    .sidebar { width: var(--sidebar-w); background-color: var(--brand-dark); color: white; position: fixed; top: 0; left: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; padding-top: 30px; z-index: 999; }
    .sidebar-header { display:flex; flex-direction:column; align-items:center; margin-bottom:25px; }
    .profile-pic { width:90px; height:90px; border-radius:50%; object-fit:cover; margin-bottom:12px; }
    .brand-name { font-size:20px; font-weight:bold; margin-bottom:25px; color:white; }
    .nav-list { list-style:none; padding:0; margin-top:10px; width:100%; }
    .nav-list li { width:100%; padding:14px 0; text-align:center; cursor:pointer; transition:.3s; border-radius:6px; }
    .nav-list li a { text-decoration:none; color:white; width:100%; display:block; }
    .nav-list li:hover { background-color:#19376d; }
    .nav-list li.active { background-color:#5d8ee9; }

    /* Main */
    .main { margin-left: var(--sidebar-w); width: calc(100% - var(--sidebar-w)); min-height:100vh; display:flex; flex-direction:column; }
    .topbar{ position: sticky; top:0; z-index:50; background:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 1px 6px rgba(0,0,0,0.06); }
    .topbar h2{ color:var(--brand-dark); font-size:18px; margin:0 }
    .search-box{ display:flex; align-items:center; gap:8px; background:#f2f6fb; padding:6px 10px; border-radius:20px; border:1px solid #e6eefc }
    .search-box input{ border:none; outline:none; background:transparent; padding:6px; width:220px }

    .content-area{ padding:22px; }
    .cards { display:flex; gap:18px; flex-wrap:wrap; margin-bottom:18px }
    .card { background:#fff; padding:18px; border-radius:10px; min-width:180px; box-shadow:0 6px 18px rgba(8,48,88,0.04); display:flex; flex-direction:column; align-items:flex-start; gap:8px }
    .card .num { font-size:20px; font-weight:700; color:var(--brand-dark) }
    .card.expired { border-left:4px solid #c62828 }
    .card.soon { border-left:4px solid #f39c12 }
    .card.safe { border-left:4px solid #16a34a }

    .controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap }
    .filter-btn { padding:8px 12px; border-radius:8px; border:1px solid #e8eef8; background:white; cursor:pointer }
    .filter-btn.active { background:var(--brand-green); color:white; border-color:transparent }

    .panel { background:#fff; padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(8,48,88,0.04) }
    .table-wrap { overflow:auto; max-height:56vh; margin-top:10px }
    table{ width:100%; border-collapse:collapse; font-size:14px; min-width:900px }
    th,td{ padding:10px 12px; border-bottom:1px solid #eef3fb; text-align:left }
    th{ background:#fbfdff; position:sticky; top:0; z-index:2 }

    .badge { padding:6px 8px; border-radius:6px; font-weight:700; display:inline-block }
    .badge.expired { background:#ffe6e6; color:#b00000 }
    .badge.soon { background:#fff4e5; color:#7a5200 }
    .badge.safe { background:#e9f9ee; color:#0b8f75 }

    .muted { color:#6b7280; font-size:13px }

    /* Pagination */
    .pagination { margin-top:12px; display:flex; gap:6px; flex-wrap:wrap; }
    .pagination button { padding:6px 10px; border-radius:6px; border:1px solid #e6eefc; background:#fff; cursor:pointer; }
    .pagination button.active { background:var(--brand-green); color:#fff; border-color:transparent; }

    /* Row highlight */
    tr.expired-row { background: #fff2f2; }
    tr.soon-row { background: #fffaf0; }

    @media (max-width:900px){
      .search-box input{ width:120px }
      .card { min-width: 140px }
      table{ font-size:13px }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="image/logo.jpg" alt="logo" class="profile-pic" />
      <div class="brand-name">PharmaTrack</div>
    </div>
    <ul class="nav-list">
      <li><a href="home.html">Home</a></li>
      <li><a href="inventory.html">Inventory</a></li>
      <li><a href="add_medicine.html">Add Medicines</a></li>
      <li class="active"><a href="expiry.html">Expiry</a></li>
      <li><a href="profile.html">Profile</a></li>
    </ul>
  </aside>

  <div class="main">
    <div class="topbar">
      <h2>Expiry Management</h2>
      <div class="search-box">
        <input id="searchInput" placeholder="Search name, batch, category..." />
        <button id="searchBtn" title="Search"><i class="fa fa-search"></i></button>
      </div>
    </div>

    <div class="content-area">
      <div class="cards">
        <div class="card expired">
          <div class="muted">Expired</div>
          <div class="num" id="expiredCount">0</div>
          <div class="muted">Items past expiry date</div>
        </div>
        <div class="card soon">
          <div class="muted">Expiring Soon</div>
          <div class="num" id="soonCount">0</div>
          <div class="muted">Items within selected days</div>
        </div>
        <div class="card safe">
          <div class="muted">Safe</div>
          <div class="num" id="safeCount">0</div>
          <div class="muted">Items with healthy expiry</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px">
        <div class="controls">
          <button class="filter-btn" data-days="30">30 days</button>
          <button class="filter-btn active" data-days="60">60 days</button>
          <button class="filter-btn" data-days="90">90 days</button>
          <div style="padding:8px 10px;border-radius:8px;background:#f6f9fc;border:1px solid #e6eefc;color:#334; font-size:13px">
            Current filter: <strong id="filterLabel">60 days</strong>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="muted">Total items in inventory: <strong id="totalItems">0</strong></div>
        </div>
      </div>

      <div class="panel">
        <div class="table-wrap">
          <table id="expiryTable">
            <thead>
              <tr>
                <th>Medicine Name</th>
                <th>Batch No.</th>
                <th>Category</th>
                <th>Qty</th>
                <th>Expiry Date</th>
                <th>Days Left</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <script>
    /*******************************
     * Expiry Page - Optimized / Clean
     * - Reads both medicineStock & inventoryData
     * - Normalizes keys (case-insensitive)
     * - Parses YYYY-MM => last day of month
     * - Accepts dd/mm/yyyy, yyyy-mm-dd, mm/dd/yyyy
     * - Sorts by expiry (nearest first)
     *******************************/
const STORAGE_KEY = 'medicineStock';

    // LOCAL STORAGE KEYS (we read both)
    const KEYS_TO_READ = ['medicineStock', 'inventoryData'];

    // default filter threshold (days)
    const THRESHOLD_DEFAULT = 60;
    const ROWS_PER_PAGE = 50;

    // current state
    let currentThreshold = THRESHOLD_DEFAULT;
    let filteredData = [];

    // --- Utility: Robust date parser & normalizer ---
    function parseDate(str) {
      if (!str && str !== 0) return null;
      if (str instanceof Date) return str;
      str = String(str).trim();
      if (!str || str === '—') return null;

      // 1) YYYY-MM  (e.g., 2025-06) -> treat as last day of month
      if (/^\d{4}-\d{2}$/.test(str)) {
        const [y, m] = str.split('-').map(Number);
        // new Date(year, monthIndex + 1, 0) -> last day of month
        return new Date(y, m, 0);
      }

      // 2) dd/mm/yyyy  (e.g., 25/06/2025)
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(str)) {
        const [d, m, y] = str.split('/').map(Number);
        return new Date(y, m - 1, d);
      }

      // 3) mm/dd/yyyy (common US format) -> detect if month>12 fallback
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(str)) {
        // already handled above identical regex; but kept for clarity.
        const [a, b, c] = str.split('/').map(Number);
        // if first part > 12 then likely dd/mm/yyyy; already handled earlier
        return new Date(c, a - 1, b);
      }

      // 4) yyyy-mm-dd or other ISO-ish -> let JS handle
      const tryIso = new Date(str);
      if (!isNaN(tryIso)) return tryIso;

      // 5) fallback: try replacing dots or spaces
      const alt = str.replace(/\./g, '-').replace(/\s+/g, '');
      const tryAlt = new Date(alt);
      return isNaN(tryAlt) ? null : tryAlt;
    }

    // days between two dates (from -> to). rounds up so partial day counts as 1
    function daysBetween(from, to) {
      return Math.ceil((to - from) / (1000 * 60 * 60 * 24));
    }

    // return badge HTML by status
    function badge(status) {
      if (status === 'Expired') return `<span class="badge expired">EXPIRED</span>`;
      if (status === 'Near Expiry') return `<span class="badge soon">EXPIRING</span>`;
      return `<span class="badge safe">SAFE</span>`;
    }

    // --- Normalizer: pick a field from row case-insensitively and with several aliases ---
    function pickField(row, aliases) {
      // aliases: array of possible keys in priority order
      for (const key of aliases) {
        // direct key
        if (key in row && row[key] !== undefined && row[key] !== null) return row[key];
      }
      // check case-insensitive keys as fallback
      const keysLower = Object.keys(row).reduce((acc, k) => {
        acc[k.toLowerCase()] = row[k];
        return acc;
      }, {});
      for (const key of aliases) {
        const low = key.toLowerCase();
        if (low in keysLower) return keysLower[low];
      }
      return undefined;
    }

    // normalize a raw row from either source into a consistent object
    function normalizeRow(raw) {
      // safe-guard if raw is null/undefined
      if (!raw || typeof raw !== 'object') return null;

      // extract fields with many alias possibilities
      const name = pickField(raw, ['Medicine Name', 'name', 'medicineName', 'medicine']);
      const batch = pickField(raw, ['Batch No.', 'Batch No', 'batch', 'batchNumber']);
      const category = pickField(raw, ['Category', 'category']);
      const qty = pickField(raw, ['Qty', 'qty', 'quantity', 'Quantity']);
      // expiry might be stored under "Expiry", "Expiry Date", "expiry", "expiryDate", etc.
      const expiryRaw = pickField(raw, ['Expiry Date', 'Expiry', 'expiry', 'expiryDate', 'ExpiryDate']);
      const statusField = pickField(raw, ['Status', 'status']);

      // Ensure numeric qty
      const qtyNum = (qty === undefined || qty === null || qty === '') ? 0 : Number(qty);

      return {
        raw, // keep original in case you want to inspect
        name: name ?? '—',
        batch: batch ?? '—',
        category: category ?? '—',
        qty: Number.isFinite(qtyNum) ? qtyNum : 0,
        expiryRaw: expiryRaw ?? '',
        statusField: statusField ?? ''
      };
    }

    // load both localStorage keys and merge into one array (no dedupe)
    function loadAllInventory() {
      const combined = [];
      KEYS_TO_READ.forEach(key => {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return;
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return;
          arr.forEach(item => {
            const norm = normalizeRow(item);
            if (norm) combined.push(norm);
          });
        } catch (e) {
          // corrupted JSON or other error -> skip
          console.warn('Error reading key', key, e);
        }
      });
      return combined;
    }

    // compute status using expiryRaw and threshold
    function computeStatus(expiryRaw, thresholdDays) {
      const d = parseDate(expiryRaw);
      if (!d) return { status: 'Safe', days: null, dateObj: null };
      const left = daysBetween(new Date(), d);
      if (left < 0) return { status: 'Expired', days: left, dateObj: d };
      if (left <= thresholdDays) return { status: 'Near Expiry', days: left, dateObj: d };
      return { status: 'Safe', days: left, dateObj: d };
    }

    // format date in DD/MM/YYYY (user requested)
    function formatDisplayDate(dateObj) {
      if (!dateObj) return '—';
      const dd = String(dateObj.getDate()).padStart(2, '0');
      const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
      const yyyy = dateObj.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    // RENDERING
    function renderTable(data, page = 1, threshold = THRESHOLD_DEFAULT) {
      const tbody = document.querySelector('#expiryTable tbody');
      tbody.innerHTML = '';

      // Sorting: nearest expiry first; entries with no expiry go last
      data.sort((a, b) => {
        const da = parseDate(a.expiryRaw);
        const db = parseDate(b.expiryRaw);
        if (!da && !db) return 0;
        if (!da) return 1;
        if (!db) return -1;
        return da - db;
      });

      // Pagination slicing
      const start = (page - 1) * ROWS_PER_PAGE;
      const end = Math.min(start + ROWS_PER_PAGE, data.length);
      let expired = 0, soon = 0, safe = 0;

      for (let i = start; i < end; i++) {
        const row = data[i];
        const st = computeStatus(row.expiryRaw, threshold);
        if (st.status === 'Expired') expired++;
        else if (st.status === 'Near Expiry') soon++;
        else safe++;

        const expiryDisplay = st.dateObj ? formatDisplayDate(st.dateObj) : '—';
        const daysText = (st.days === null) ? '—' : (st.days < 0 ? `${Math.abs(st.days)} days ago` : `${st.days} days`);

        const tr = document.createElement('tr');
        // add classes for row highlight
        if (st.status === 'Expired') tr.classList.add('expired-row');
        else if (st.status === 'Near Expiry') tr.classList.add('soon-row');

        tr.innerHTML = `
          <td>${escapeHtml(row.name)}</td>
          <td>${escapeHtml(row.batch)}</td>
          <td>${escapeHtml(row.category)}</td>
          <td>${row.qty}</td>
          <td>${expiryDisplay}</td>
          <td>${daysText}</td>
          <td>${badge(st.status)}</td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById('expiredCount').textContent = expired;
      document.getElementById('soonCount').textContent = soon;
      document.getElementById('safeCount').textContent = safe;
      document.getElementById('totalItems').textContent = data.length;

      renderPagination(data.length, page);
    }

    // pagination UI
    function renderPagination(totalItems, currentPage) {
      const totalPages = Math.max(1, Math.ceil(totalItems / ROWS_PER_PAGE));
      const container = document.getElementById('pagination');
      container.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.addEventListener('click', () => {
          renderTable(filteredData, i, currentThreshold);
        });
        container.appendChild(btn);
      }
    }

    // Escape HTML to avoid accidental injection if data contains special chars
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // renderAll: load, filter by search, set filteredData
    function renderAll(searchTerm = '') {
      const all = loadAllInventory();

      // filter by search term (name, batch, category)
      const s = String(searchTerm || '').toLowerCase().trim();
      filteredData = all.filter(row => {
        const combined = `${row.name} ${row.batch} ${row.category}`.toLowerCase();
        return combined.includes(s);
      });

      // Sort by expiry nearest first (renderTable re-sorts anyway but keep here)
      filteredData.sort((a, b) => {
        const da = parseDate(a.expiryRaw);
        const db = parseDate(b.expiryRaw);
        if (!da && !db) return 0;
        if (!da) return 1;
        if (!db) return -1;
        return da - db;
      });

      // Render first page
      renderTable(filteredData, 1, currentThreshold);
    }

    // Initialize UI and events
    (function initUI() {
      // filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentThreshold = Number(btn.dataset.days);
          document.getElementById('filterLabel').textContent = currentThreshold + ' days';
          renderAll(document.getElementById('searchInput').value);
        });
      });

      // search input
      const si = document.getElementById('searchInput');
      si.addEventListener('input', e => {
        renderAll(e.target.value);
      });

      // search button click (optional)
      document.getElementById('searchBtn').addEventListener('click', () => {
        renderAll(document.getElementById('searchInput').value);
      });

      // initial render
      renderAll();
    })();
  </script>
</body>
</html>



