<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expiry - PharmaWise</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --sidebar-w:300px;
      --brand-dark:#0b214a;
      --brand-green:#0b8f75;
      --muted:#f4f6f8;
      --accent:#fcd34d;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--muted);color:#222}

    /* Sidebar */
    .sidebar { width: var(--sidebar-w); background-color: var(--brand-dark); color: white; position: fixed; top: 0; left: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; padding-top: 30px; z-index: 999; }
    .sidebar-header { display:flex; flex-direction:column; align-items:center; margin-bottom:25px; }
    .profile-pic { width:90px; height:90px; border-radius:50%; object-fit:cover; margin-bottom:12px; }
    .brand-name { font-size:20px; font-weight:bold; margin-bottom:25px; color:white; }
    .nav-list { list-style:none; padding:0; margin-top:10px; width:100%; }
    .nav-list li { width:100%; padding:14px 0; text-align:center; cursor:pointer; transition:.3s; border-radius:6px; }
    .nav-list li a { text-decoration:none; color:white; width:100%; display:block; }
    .nav-list li:hover { background-color:#19376d; }
    .nav-list li.active { background-color:#5d8ee9; }

    /* Main */
    .main { margin-left: var(--sidebar-w); width: calc(100% - var(--sidebar-w)); min-height:100vh; display:flex; flex-direction:column; }
    .topbar{ position: sticky; top:0; z-index:50; background:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 1px 6px rgba(0,0,0,0.06); }
    .topbar h2{ color:var(--brand-dark); font-size:18px; margin:0 }
    .search-box{ display:flex; align-items:center; gap:8px; background:#f2f6fb; padding:6px 10px; border-radius:20px; border:1px solid #e6eefc }
    .search-box input{ border:none; outline:none; background:transparent; padding:6px; width:220px }

    .content-area{ padding:22px; }
    .cards { display:flex; gap:18px; flex-wrap:wrap; margin-bottom:18px }
    .card { background:#fff; padding:18px; border-radius:10px; min-width:180px; box-shadow:0 6px 18px rgba(8,48,88,0.04); display:flex; flex-direction:column; align-items:flex-start; gap:8px }
    .card .num { font-size:20px; font-weight:700; color:var(--brand-dark) }
    .card.expired { border-left:4px solid #c62828 }
    .card.soon { border-left:4px solid #f39c12 }
    .card.safe { border-left:4px solid #16a34a }

    .controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap }
    .filter-btn { padding:8px 12px; border-radius:8px; border:1px solid #e8eef8; background:white; cursor:pointer }
    .filter-btn.active { background:var(--brand-green); color:white; border-color:transparent }

    .panel { background:#fff; padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(8,48,88,0.04) }
    .table-wrap { overflow:auto; max-height:56vh; margin-top:10px }
    table{ width:100%; border-collapse:collapse; font-size:14px; min-width:900px }
    th,td{ padding:10px 12px; border-bottom:1px solid #eef3fb; text-align:left }
    th{ background:#fbfdff; position:sticky; top:0; z-index:2 }

    .badge { padding:6px 8px; border-radius:6px; font-weight:700; display:inline-block }
    .badge.expired { background:#ffe6e6; color:#b00000 }
    .badge.soon { background:#fff4e5; color:#7a5200 }
    .badge.safe { background:#e9f9ee; color:#0b8f75 }

    .muted { color:#6b7280; font-size:13px }

    @media (max-width:900px){
      .search-box input{ width:120px }
      .card { min-width: 140px }
      table{ font-size:13px }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="image/logo.jpg" alt="logo" class="profile-pic" />
      <div class="brand-name">PharmaTrack</div>
    </div>
    <ul class="nav-list">
      <li><a href="home.html">Home</a></li>
      <li><a href="inventory.html">Inventory</a></li>
      <li><a href="add_medicine.html">Add Medicines</a></li>
      <li class="active"><a href="expiry.html">Expiry</a></li>
      <li><a href="profile.html">Profile</a></li>
    </ul>
  </aside>

  <div class="main">
    <div class="topbar">
      <h2>Expiry Management</h2>
      <div class="search-box">
        <input id="searchInput" placeholder="Search name, batch, category..." />
        <button id="searchBtn" title="Search"><i class="fa fa-search"></i></button>
      </div>
    </div>

    <div class="content-area">
      <div class="cards">
        <div class="card expired">
          <div class="muted">Expired</div>
          <div class="num" id="expiredCount">0</div>
          <div class="muted">Items past expiry date</div>
        </div>
        <div class="card soon">
          <div class="muted">Expiring Soon</div>
          <div class="num" id="soonCount">0</div>
          <div class="muted">Items within selected days</div>
        </div>
        <div class="card safe">
          <div class="muted">Safe</div>
          <div class="num" id="safeCount">0</div>
          <div class="muted">Items with healthy expiry</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px">
        <div class="controls">
          <button class="filter-btn" data-days="30">30 days</button>
          <button class="filter-btn active" data-days="60">60 days</button>
          <button class="filter-btn" data-days="90">90 days</button>
          <div style="padding:8px 10px;border-radius:8px;background:#f6f9fc;border:1px solid #e6eefc;color:#334; font-size:13px">
            Current filter: <strong id="filterLabel">60 days</strong>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="muted">Total items in inventory: <strong id="totalItems">0</strong></div>
        </div>
      </div>

      <div class="panel">
        <div class="table-wrap">
          <table id="expiryTable">
            <thead>
              <tr>
                <th>Medicine Name</th>
                <th>Batch No.</th>
                <th>Category</th>
                <th>Qty</th>
                <th>Expiry Date</th>
                <th>Days Left</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'inventoryData';
    const THRESHOLD_DEFAULT = 60;

    function parseDate(str) {
      if (!str) return null;
      if (str instanceof Date) return str;
      const d1 = new Date(str);
      if (!isNaN(d1)) return d1;
      // fallback dd/mm/yyyy
      const parts = str.split('/');
      if (parts.length === 3) return new Date(parts[2], parts[1]-1, parts[0]);
      return null;
    }

    function daysBetween(from,to){ return Math.ceil((to-from)/(1000*60*60*24)); }

    function badge(status){
      if(status==='Expired') return `<span class="badge expired">EXPIRED</span>`;
      if(status==='Near Expiry') return `<span class="badge soon">EXPIRING</span>`;
      return `<span class="badge safe">SAFE</span>`;
    }

    function loadInventory(){
      try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }
      catch(e){ return []; }
    }

    function computeStatus(row,threshold){
      const expiryRaw = row['Expiry Date'] ?? row['expiry'] ?? '';
      const d = parseDate(expiryRaw);
      if(d){
        const left = daysBetween(new Date(),d);
        if(left<0) return {status:'Expired',days:left};
        if(left<=threshold) return {status:'Near Expiry',days:left};
        return {status:'Safe',days:left};
      }
      return {status:'Safe',days:null};
    }

    function render(threshold=THRESHOLD_DEFAULT,searchTerm=''){
      const data=loadInventory();
      const tbody=document.querySelector('#expiryTable tbody'); 
      tbody.innerHTML='';
      let expired=0,soon=0,safe=0;
      const s=searchTerm.toLowerCase().trim();

      data.forEach(row=>{
        const name=row['Medicine Name']??row['name']??'—';
        const batch=row['Batch No.']??row['batch']??'—';
        const category=row['Category']??row['category']??'—';
        const qty=row['Qty']??row['qty']??0;

        const st=computeStatus(row,threshold);
        const combined=`${name} ${batch} ${category}`.toLowerCase();
        if(s && !combined.includes(s)) return;

        if(st.status==='Expired') expired++;
        else if(st.status==='Near Expiry') soon++;
        else safe++;

        const daysText = st.days===null?'—':(st.days<0?`${Math.abs(st.days)} days ago`:`${st.days} days`);
        const expiryDisplay = parseDate(row['Expiry Date'])?parseDate(row['Expiry Date']).toLocaleDateString('en-GB',{month:'2-digit',year:'numeric'}):'—';

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${name}</td>
          <td>${batch}</td>
          <td>${category}</td>
          <td>${qty}</td>
          <td>${expiryDisplay}</td>
          <td>${daysText}</td>
          <td>${badge(st.status)}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('expiredCount').textContent=expired;
      document.getElementById('soonCount').textContent=soon;
      document.getElementById('safeCount').textContent=safe;
      document.getElementById('totalItems').textContent=data.length;
    }

    (function initUI(){
      let threshold = THRESHOLD_DEFAULT;
      document.querySelectorAll('.filter-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          threshold = Number(btn.dataset.days);
          document.getElementById('filterLabel').textContent = threshold+' days';
          render(threshold,document.getElementById('searchInput').value);
        });
      });
      document.getElementById('searchInput').addEventListener('input',e=>render(threshold,e.target.value));
      render();
    })();
  </script>
</body>
</html>
