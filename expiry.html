<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expiry - PharmaWise</title>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --sidebar-w:300px;
      --brand-dark:#0b214a;
      --brand-green:#0b8f75;
      --muted:#f4f6f8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--muted);color:#222}

    /* ---------------- Sidebar (matches other pages) ---------------- */
   .sidebar {
  width: 300px;
  background-color: #0b214a;
  color: white;
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;         /* Full height */
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 30px;
   z-index: 999 !important;
}

/* Profile & Brand */
.sidebar-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 25px;
}

.sidebar .profile-pic {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 12px;
}

.brand-name {
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 25px;
  color: white;
}

/* Menu Items */
.nav-list {
  list-style: none;
  padding: 0;
  margin-top: 10px;
  width: 100%;
}

.nav-list li {
  width: 100%;
  padding: 14px 0;
  text-align: center;
  cursor: pointer;
  transition: 0.3s;
  border-radius: 6px;
}

.nav-list li a {
  text-decoration: none;
  color: white;
  width: 100%;
  display: block;
}

/* Hover & Active */
.nav-list li:hover {
  background-color: #19376d;
}

.nav-list li.active {
  background-color: #5d8ee9;
}


    /* ---------------- Main area ---------------- */
    .main {
      margin-left:var(--sidebar-w);
      width:calc(100% - var(--sidebar-w));
      min-height:100vh;
      display:flex; flex-direction:column;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 1px 6px rgba(0,0,0,0.06);
    }
    .topbar h2{ color:var(--brand-dark); font-size:18px; margin:0 }
    .search-box{ display:flex; align-items:center; gap:8px; background:#f2f6fb; padding:6px 10px; border-radius:20px; border:1px solid #e6eefc }
    .search-box input{ border:none; outline:none; background:transparent; padding:6px; width:220px }

    /* Content area */
    .content-area{ padding:22px; }

    /* Cards */
    .cards { display:flex; gap:18px; flex-wrap:wrap; margin-bottom:18px }
    .card { background:#fff; padding:18px; border-radius:10px; min-width:180px; box-shadow:0 6px 18px rgba(8,48,88,0.04); display:flex; flex-direction:column; align-items:flex-start; gap:8px }
    .card .num { font-size:20px; font-weight:700; color:var(--brand-dark) }
    .card.expired { border-left:4px solid #c62828 }
    .card.soon { border-left:4px solid #f39c12 }
    .card.safe { border-left:4px solid #16a34a }

    /* Controls */
    .controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap }
    .filter-btn { padding:8px 12px; border-radius:8px; border:1px solid #e8eef8; background:white; cursor:pointer }
    .filter-btn.active { background:#0b8f75; color:white; border-color:transparent }

    /* Table */
    .panel { background:#fff; padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(8,48,88,0.04) }
    .table-wrap { overflow:auto; max-height:56vh; margin-top:10px }
    table{ width:100%; border-collapse:collapse; font-size:14px; min-width:900px }
    th,td{ padding:10px 12px; border-bottom:1px solid #eef3fb; text-align:left }
    th{ background:#fbfdff; position:sticky; top:0; z-index:2 }
    .badge { padding:6px 8px; border-radius:6px; font-weight:700; display:inline-block }
    .badge.expired { background:#ffe6e6; color:#b00000 }
    .badge.soon { background:#fff4e5; color:#7a5200 }
    .badge.safe { background:#e9f9ee; color:#0b8f75 }

    /* small helpers */
    .muted { color:#6b7280; font-size:13px }

    @media (max-width:900px){
      .search-box input{ width:120px }
      .card { min-width: 140px }
      table{ font-size:13px }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="image/logo.jpg" alt="logo" class="profile-pic" />
      <div class="brand-name">PharmaTrack</div>
    
    </div>

    <ul class="nav-list">
      <li><a href="home.html">Home</a></li>
      <li><a href="inventory.html">Inventory</a></li>
      <li><a href="add_medicine.html">Add Medicines</a></li>
      <li class="active"><a href="expiry.html">Expiry</a></li>
      <li><a href="profile.html">Profile</a></li>
    </ul>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <h2>Expiry Management</h2>
      <div class="search-box">
        <input id="searchInput" placeholder="Search name, batch, category..." />
        <button id="searchBtn" title="Search"><i class="fa fa-search"></i></button>
      </div>
    </div>

    <div class="content-area">
      <!-- Summary cards -->
      <div class="cards">
        <div class="card expired">
          <div class="muted">Expired</div>
          <div class="num" id="expiredCount">0</div>
          <div class="muted">Items past expiry date</div>
        </div>
        <div class="card soon">
          <div class="muted">Expiring Soon</div>
          <div class="num" id="soonCount">0</div>
          <div class="muted">Items within selected days</div>
        </div>
        <div class="card safe">
          <div class="muted">Safe</div>
          <div class="num" id="safeCount">0</div>
          <div class="muted">Items with healthy expiry</div>
        </div>
      </div>

      <!-- Controls -->
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px">
        <div class="controls">
          <button class="filter-btn" data-days="30">30 days</button>
          <button class="filter-btn active" data-days="60">60 days</button>
          <button class="filter-btn" data-days="90">90 days</button>
          <div style="padding:8px 10px;border-radius:8px;background:#f6f9fc;border:1px solid #e6eefc;color:#334; font-size:13px">
            Current filter: <strong id="filterLabel">60 days</strong>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <div class="muted">Total items in inventory: <strong id="totalItems">0</strong></div>
        </div>
      </div>

      <!-- Panel with tables -->
      <div class="panel">
        <div class="table-wrap">
          <table id="expiryTable">
            <thead>
              <tr>
                <th>Medicine Name</th>
                <th>Batch No.</th>
                <th>Category</th>
                <th>Qty</th>
                <th>Expiry Date</th>
                <th>Days Left</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows injected here -->
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    // KEY used by inventory page
    const STORAGE_KEY = 'pharma_inventory_v1';

    // helpers
    function parseExpiryToDate(str){
      if(!str) return null;
      if(str instanceof Date) return str;
      // if user stored MM/YYYY (like 01/2026)
      const mmYYYY = String(str).match(/^(\d{1,2})[\/\-](\d{4})$/);
      if(mmYYYY){
        const m = parseInt(mmYYYY[1],10);
        const y = parseInt(mmYYYY[2],10);
        return new Date(y, m, 0, 23,59,59); // last day of month
      }
      const iso = Date.parse(str);
      if(!isNaN(iso)) return new Date(iso);
      return null;
    }

    function daysBetween(from, to){
      const diff = to - from;
      return Math.ceil(diff / (1000*60*60*24));
    }

    function computeRowStatus(row, thresholdDays){
      const qty = Number(row['Qty'] ?? row['qty'] ?? row['Quantity'] ?? 0);
      const expiryRaw = row['Expiry Date'] ?? row['Expiry'] ?? row['expiry'] ?? '';
      const d = parseExpiryToDate(expiryRaw);
      const now = new Date();
      if(d){
        const daysLeft = daysBetween(now, d);
        if(daysLeft < 0) return {status:'EXPIRED', daysLeft};
        if(daysLeft <= thresholdDays) return {status:'EXPIRING', daysLeft};
        return {status:'SAFE', daysLeft};
      } else {
        // unknown expiry -> treat as safe unless qty low
        if(!isNaN(qty) && qty <= 20) return {status:'LOW STOCK', daysLeft: null};
        return {status:'UNKNOWN', daysLeft: null};
      }
    }

    function formatExpiry(str){
      const d = parseExpiryToDate(str);
      if(!d) return str || '';
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return mm + '/' + yyyy;
    }

    function badgeForStatus(s){
      if(!s) return '<span class="badge safe">SAFE</span>';
      if(s === 'EXPIRED') return '<span class="badge expired">EXPIRED</span>';
      if(s === 'EXPIRING') return '<span class="badge soon">EXPIRING</span>';
      if(s === 'LOW STOCK') return '<span class="badge expired">LOW STOCK</span>';
      return '<span class="badge safe">' + s + '</span>';
    }

    // load data from localStorage
    function loadInventory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      }catch(e){ console.warn(e); return []; }
    }

    // render table & cards
    function render(thresholdDays = 60, searchTerm = ''){
      const data = loadInventory();
      const tbody = document.querySelector('#expiryTable tbody');
      tbody.innerHTML = '';

      let total = data.length;
      let expiredCount = 0;
      let soonCount = 0;
      let safeCount = 0;

      const now = new Date();
      const s = (searchTerm||'').toLowerCase().trim();

      data.forEach(row=>{
        const name = (row['Medicine Name'] ?? row['name'] ?? '').toString();
        const batch = (row['Batch No.'] ?? row['batch'] ?? '').toString();
        const category = (row['Category'] ?? row['category'] ?? '').toString();
        const qty = row['Qty'] ?? row['qty'] ?? row['Quantity'] ?? 0;
        const expiryRaw = row['Expiry Date'] ?? row['Expiry'] ?? row['expiry'] ?? '';
        const d = parseExpiryToDate(expiryRaw);
        const daysLeft = d ? daysBetween(now, d) : null;

        // compute status using thresholdDays
        const st = computeRowStatus(row, thresholdDays);

        // filter by search
        const combined = (name + ' ' + batch + ' ' + category).toLowerCase();
        if(s && !combined.includes(s)) return;

        // count categories
        if(st.status === 'EXPIRED') expiredCount++;
        else if(st.status === 'EXPIRING') soonCount++;
        else safeCount++;

        const daysText = daysLeft === null ? 'â€”' : (daysLeft < 0 ? (Math.abs(daysLeft) + ' days ago') : (daysLeft + ' days'));
        const expiryDisplay = formatExpiry(expiryRaw);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(name)}</td>
          <td>${escapeHtml(batch)}</td>
          <td>${escapeHtml(category)}</td>
          <td>${escapeHtml(qty)}</td>
          <td>${escapeHtml(expiryDisplay)}</td>
          <td>${escapeHtml(daysText)}</td>
          <td>${badgeForStatus(st.status)}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('expiredCount').textContent = expiredCount;
      document.getElementById('soonCount').textContent = soonCount;
      document.getElementById('safeCount').textContent = safeCount;
      document.getElementById('totalItems').textContent = total;
    }

    function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // UI wiring
    (function initUI(){
      let selectedDays = 60;
      const filterButtons = document.querySelectorAll('.filter-btn');
      filterButtons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          filterButtons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          selectedDays = Number(btn.getAttribute('data-days') || 60);
          document.getElementById('filterLabel').textContent = selectedDays + ' days';
          render(selectedDays, document.getElementById('searchInput').value);
        });
      });

      // search
      document.getElementById('searchInput').addEventListener('input', (e)=>{
        render(selectedDays, e.target.value);
      });

      // highlight active menu (ensure expiry active)
      (function highlightActive(){
        const current = window.location.pathname.split('/').pop() || 'expiry.html';
        document.querySelectorAll('.nav-list li').forEach(li=>{
          const a = li.querySelector('a');
          if(!a) return;
          if(a.getAttribute('href') === current) li.classList.add('active');
          else li.classList.remove('active');
        });
      })();

      // initial render
      render(selectedDays, '');
    })();
  </script>
</body>
</html>
