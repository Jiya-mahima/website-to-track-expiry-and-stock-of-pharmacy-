<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventory - PharmaWise</title>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- SheetJS (XLSX) for Excel/CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* ---------- Basic layout (sidebar + topbar + main) ---------- */
    :root{
      --sidebar-w:280px;
      --brand-green:#0b8f75;
      --brand-dark:#0b214a;
      --muted:#f4f6f8;
      --panel-width:450px;
      --overlay-rgba: rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--muted);color:#222}
    /* Sidebar */
    .sidebar {
      width: 300px;
      background-color: #0b214a;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;         /* Full height */
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 30px;
      z-index: 999 !important;
    }

    .sidebar-header { display:flex; flex-direction:column; align-items:center; margin-bottom:25px }
    .sidebar .profile-pic { width:90px; height:90px; border-radius:50%; object-fit:cover; margin-bottom:12px }
    .brand-name { font-size:20px; font-weight:bold; color:white }

    .nav-list { list-style:none; padding:0; margin-top:10px; width:100% }
    .nav-list li { width:100%; padding:14px 0; text-align:center; cursor:pointer; transition:0.3s; border-radius:6px }
    .nav-list li a { text-decoration:none; color:white; width:100%; display:block }
    .nav-list li:hover { background-color:#19376d }
    .nav-list li.active { background-color:#5d8ee9 }

    /* ===== Main Page (Right Content) ===== */
    .main { margin-left:300px; width:calc(100% - 300px); min-height:100vh; display:flex; flex-direction:column }

    .topbar { background-color:#fff; display:flex; justify-content:space-between; align-items:center; padding:15px 30px; box-shadow:0 2px 5px rgba(0,0,0,0.1) }
    .topbar h2 { color:#0b214a; font-size:20px }
    .search-box{ display:flex; align-items:center; gap:8px; background:#f2f6fb; padding:6px 10px; border-radius:20px; border:1px solid #e6eefc }
    .search-box input{ border:none; outline:none; background:transparent; padding:6px; width:230px }

    .content-area{ padding:22px }
    .panel { background:#fff; border-radius:10px; padding:18px; box-shadow:0 6px 18px rgba(8,48,88,0.04) }
    .panel .toolbar{ display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap }
    .btn { background:var(--brand-green); color:#fff; padding:10px 14px; border-radius:8px; border:none; cursor:pointer }
    .btn.secondary { background:#2b74d6 }
    .btn.grey { background:#f0f2f7; color:#123; border:1px solid #e6eefc }

    .file-wrapper{ display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; background:#f7fafb; border:1px dashed #d9e6ef }
    .file-wrapper input[type=file]{ display:inline-block }

    .table-wrap{ overflow:auto; max-height:62vh; padding-top:6px }
    table{ width:100%; border-collapse:collapse; font-size:14px; min-width:900px }
    th,td{ padding:10px 12px; border-bottom:1px solid #eef3fb; text-align:left; vertical-align:middle }
    th{ background:#f8fbff; color:#0b214a; position:sticky; top:0; z-index:2 }
    .status-safe{ background:#e7f9ee; color:#137a2f; padding:6px 8px; border-radius:6px; font-weight:600; display:inline-block }
    .status-low{ background:#fff0f0; color:#a60000; padding:6px 8px; border-radius:6px; font-weight:600; display:inline-block }
    .status-expiring{ background:#fff7e6; color:#8a6d00; padding:6px 8px; border-radius:6px; font-weight:600; display:inline-block }
    .status-expired{ background:#fdecea; color:#8a0000; padding:6px 8px; border-radius:6px; font-weight:700; display:inline-block }
    .status-out{ background:#f5f5f5; color:#666; padding:6px 8px; border-radius:6px; font-weight:700; display:inline-block }

    .action-btn{ background:#eef6f9; color:#0b214a; border-radius:6px; padding:6px 10px; border:0; cursor:pointer }

    @media (max-width:900px){ .search-box input{ width:120px } .panel{ padding:12px } }

    /* ---------------- Slide-in Details Panel (Light UI) ---------------- */
    .overlay {
      position:fixed;
      inset:0;
      background: transparent;
      opacity:0;
      visibility:hidden;
      transition: opacity 220ms ease, visibility 220ms ease;
      z-index:1200;
      display:flex;
      justify-content:flex-end;
    }
    .overlay.show {
      background: var(--overlay-rgba);
      opacity:1;
      visibility:visible;
    }
    .side-panel {
      width: var(--panel-width);
      max-width: 100%;
      height:100%;
      background: #ffffff;
      box-shadow: -18px 0 40px rgba(2,15,34,0.12);
      transform: translateX(110%);
      transition: transform 260ms cubic-bezier(.2,.9,.2,1);
      padding:20px 20px;
      display:flex;
      flex-direction:column;
      z-index:1300;
    }
    .overlay.show .side-panel { transform: translateX(0); }

    .panel-header { display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid #eef3fb; padding-bottom:12px; margin-bottom:12px }
    .panel-header h3 { margin:0; color:#0b214a; font-size:18px }
    .panel-body { overflow:auto; flex:1; padding-right:6px; }
    .panel-row { display:flex; gap:12px; margin-bottom:10px; align-items:center }
    .field { flex:1; }
    .field .label { font-size:12px; color:#6b7280; margin-bottom:6px; display:block }
    .field .value { font-size:14px; color:#0b214a; font-weight:600 }

    /* two-column compact layout (L3 style) */
    .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:10px 14px; }
    .panel-footer { padding-top:12px; border-top:1px solid #f1f5f9; margin-top:12px; display:flex; justify-content:center }
    .view-full-btn { background:#0b214a; color:#fff; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; width:70% }

    /* small close */
    .close-btn { background:transparent; border:0; font-size:20px; cursor:pointer; color:#6b7280 }

    /* responsive tweak */
    @media (max-width:600px){
      .side-panel{ width:100% }
      .two-col{ grid-template-columns: 1fr }
      .view-full-btn{ width:100% }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="image/logo.jpg" alt="logo" class="profile-pic" />
      <div class="brand-name">PharmaTrack</div>
    </div>

    <ul class="nav-list">
      <li><a href="home.html">Home</a></li>
      <li class="active"><a href="inventory.html">Inventory</a></li>
      <li><a href="add_medicine.html">Add Medicines</a></li>
      <li><a href="expiry.html">Expiry</a></li>
      <li><a href="profile.html">Profile</a></li>
    </ul>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <h2>Pharmacy Inventory Management</h2>
      <div class="search-box">
        <input id="globalSearch" placeholder="Search inventory..." />
        <button id="searchBtn" title="Search"><i class="fa fa-search"></i></button>
      </div>
    </div>

    <div class="content-area">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div class="toolbar">
            <button class="btn" id="addBtn">➕ Add Medicine</button>
            <label class="file-wrapper" title="Upload Excel/CSV">
              <input type="file" id="excelFile" accept=".xlsx,.xls,.csv">
              <span style="font-size:13px">Upload Excel / CSV</span>
            </label>
            <button class="btn grey" id="clearBtn" title="Clear inventory">Clear Inventory</button>
          </div>

          <div style="font-size:13px;color:#555">Tip: upload Excel/CSV with headers: <strong>Medicine Name, Batch No., Category, Qty, Expiry Date, Status</strong></div>
        </div>

        <div class="table-wrap" id="tableWrap">
          <table id="inventoryTable">
            <thead>
              <tr>
                <th>Medicine Name</th>
                <th>Batch No.</th>
                <th>Category</th>
                <th>Qty</th>
                <th>Expiry Date</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- rows injected here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay + Side Panel (Details) -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <aside class="side-panel" role="dialog" aria-labelledby="detailsTitle" aria-modal="true">
      <div class="panel-header">
        <h3 id="detailsTitle">Medicine Details</h3>
        <button id="closePanel" class="close-btn" title="Close">&times;</button>
      </div>
      <div class="panel-body">
        <div class="two-col">
          <div class="field">
            <span class="label">Expiry Date</span>
            <div id="detailExpiry" class="value">—</div>
          </div>
          <div class="field">
            <span class="label">Medicine Name</span>
            <div id="detailName" class="value">—</div>
          </div>

          <div class="field">
            <span class="label">Category</span>
            <div id="detailCategory" class="value">—</div>
          </div>
          <div class="field">
            <span class="label">Batch No.</span>
            <div id="detailBatch" class="value">—</div>
          </div>

          <div class="field">
            <span class="label">Quantity</span>
            <div id="detailQty" class="value">—</div>
          </div>
          <div class="field">
            <span class="label">Status</span>
            <div id="detailStatus" class="value">—</div>
          </div>
        </div>
      </div>

      <div class="panel-footer">
        <button id="viewFullBtn" class="view-full-btn" type="button">View Full Details</button>
      </div>
    </aside>
  </div>

  <script>
    /********************
     Utility & state
    ********************/
    const STORAGE_KEY = 'pharma_inventory_v1';

    /********************
     Date / Status helpers
    ********************/
    function parseExpiryToDate(str) {
      if(!str) return null;
      if (str instanceof Date) return str;
      // trim
      str = String(str).trim();
      // Accept MM/YYYY or M/YYYY
      const mmYYYY = str.match(/^(\d{1,2})[\/\-](\d{4})$/);
      if(mmYYYY){
        const m = parseInt(mmYYYY[1],10);
        const y = parseInt(mmYYYY[2],10);
        return new Date(y, m, 0, 23,59,59); // last day of month
      }
      // Try Excel serial number (integer)
      if(/^\d+$/.test(str) && Number(str) > 59){ // Excel dates start from 1; robust check
        const serial = Number(str);
        // Excel serial to JS date (assuming 1900 date system)
        const utc_days  = serial - 25569;
        const utc_value = utc_days * 86400;                                        
        const date_info = new Date(utc_value * 1000);
        if(!isNaN(date_info)) return date_info;
      }
      // ISO / normal parse
      const iso = Date.parse(str);
      if(!isNaN(iso)) return new Date(iso);
      // fallback null
      return null;
    }

    function formatExpiryForDisplay(str){
      const d = parseExpiryToDate(str);
      if(!d) return (str || '—');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${mm}/${yyyy}`;
    }

    // Status rules (as requested earlier)
    function computeStatusFromRow(row){
      const qtyRaw = row['Qty'] ?? row['qty'] ?? row['Quantity'] ?? row['quantity'] ?? 0;
      const qty = Number(qtyRaw ?? 0);
      const expiryStr = row['Expiry Date'] ?? row['Expiry'] ?? row['expiry'] ?? '';
      const d = parseExpiryToDate(expiryStr);
      const now = new Date();

      if(isNaN(qty) === false && qty === 0) return 'Out of Stock';
      if(isNaN(qty) === false && qty < 10) return 'Low Stock';
      if(d){
        const diffMs = d - now;
        const diffDays = Math.ceil(diffMs / (1000*60*60*24));
        if(diffDays < 0) return 'Expired';
        if(diffDays <= 30) return 'Near Expiry';
      }
      return 'In Stock';
    }

    function statusToBadge(s){
      if(!s) return '';
      if(s === 'Low Stock') return `<span class="status-low">${s}</span>`;
      if(s === 'Near Expiry') return `<span class="status-expiring">${s}</span>`;
      if(s === 'Expired') return `<span class="status-expired">${s}</span>`;
      if(s === 'Out of Stock') return `<span class="status-out">${s}</span>`;
      return `<span class="status-safe">${s}</span>`;
    }

    function escapeHtml(t){ if(t===undefined || t===null) return ''; return String(t).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    /********************
     Storage: load / save (no demo data)
    ********************/
    function loadInventory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];               // <-- NO demo data, return empty array
        return JSON.parse(raw);
      }catch(e){
        console.warn('load error', e);
        return [];
      }
    }

    function saveInventory(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    /********************
     Render table
    ********************/
    function rowToTr(row, idx){
      const name = row['Medicine Name'] || row['name'] || '';
      const batch = row['Batch No.'] || row['Batch No'] === '' ? (row['Batch No.'] ?? row['Batch'] ?? row['batch'] ?? '') : (row['Batch'] ?? row['batch'] ?? '');
      const category = row['Category'] || row['category'] || '';
      const qty = row['Qty'] || row['qty'] || row['Quantity'] || 0;
      const expiryRaw = row['Expiry Date'] || row['Expiry'] || row['expiry'] || '';
      const expiry = formatExpiryForDisplay(expiryRaw);
      const status = computeStatusFromRow({ 'Qty': qty, 'Expiry Date': expiryRaw });

      const tr = document.createElement('tr');
      tr.dataset.index = idx;
      tr.innerHTML = `
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(batch)}</td>
        <td>${escapeHtml(category)}</td>
        <td>${escapeHtml(qty)}</td>
        <td>${escapeHtml(expiry)}</td>
        <td>${statusToBadge(status)}</td>
        <td><button class="action-btn details-btn" data-index="${idx}">Details</button></td>
      `;
      return tr;
    }

    function renderTable(data){
      const tbody = document.querySelector('#inventoryTable tbody');
      tbody.innerHTML = '';
      if(!data || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#666;padding:18px">No Data Available</td></tr>`;
        attachDetailButtons(); // still attach nothing
        return;
      }
      data.forEach((row, i) => tbody.appendChild(rowToTr(row, i)));
      attachDetailButtons();
    }

    function refreshUI(){
      const data = loadInventory();
      renderTable(data);
    }

    /********************
     Search filter
    ********************/
    function filterTable(text){
      text = (text||'').toLowerCase().trim();
      const rows = document.querySelectorAll('#inventoryTable tbody tr');
      rows.forEach(r=>{
        const txt = r.innerText.toLowerCase();
        r.style.display = txt.includes(text) ? '' : 'none';
      });
    }

    document.getElementById('globalSearch').addEventListener('input', (e)=>{
      filterTable(e.target.value);
    });

    /********************
     File upload (Excel / CSV) handling
    ********************/
    document.getElementById('excelFile').addEventListener('change', function(e){
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(evt){
        const data = evt.target.result;
        let workbook;
        try {
          workbook = XLSX.read(data, {type: 'binary'});
        } catch(err){
          alert('Failed to parse file. Make sure it is a valid Excel or CSV file.');
          return;
        }
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, {raw:false, defval:''});
        if(!json || !json.length){
          alert('No rows found in the uploaded sheet.');
          return;
        }

        // Normalize keys to expected names
        const normalized = json.map(r=>{
          return {
            'Medicine Name': r['Medicine Name'] ?? r['Medicine'] ?? r['medicine name'] ?? r['medicine'] ?? '',
            'Batch No.': r['Batch No.'] ?? r['Batch'] ?? r['batch'] ?? '',
            'Category': r['Category'] ?? r['category'] ?? '',
            'Qty': (r['Qty'] ?? r['Quantity'] ?? r['qty'] ?? 0),
            'Expiry Date': r['Expiry Date'] ?? r['Expiry'] ?? r['expiry'] ?? '',
            'Status': r['Status'] ?? ''
          };
        });

        // Save to localStorage and render (replace existing)
        saveInventory(normalized);
        renderTable(normalized);
        e.target.value = '';
        alert('File uploaded and inventory replaced successfully.');
      };
      // read as binary string
      reader.readAsBinaryString(f);
    });

    /********************
     Add button (redirect)
    ********************/
    document.getElementById('addBtn').addEventListener('click', () => {
      window.location.href = 'add_medicine.html';
    });

    /********************
     Clear Inventory
    ********************/
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(!confirm('This will clear saved inventory (local). Continue?')) return;
      localStorage.removeItem(STORAGE_KEY);
      refreshUI();
    });

    /********************
     Details buttons (attach)
    ********************/
    function attachDetailButtons(){
      document.querySelectorAll('.details-btn').forEach(b=>{
        b.removeEventListener('click', onDetailsClick); // safe remove if previously attached
        b.addEventListener('click', onDetailsClick);
      });
    }

    // Details panel elements
    const overlay = document.getElementById('overlay');
    const closePanelBtn = document.getElementById('closePanel');
    const detailExpiry = document.getElementById('detailExpiry');
    const detailName = document.getElementById('detailName');
    const detailCategory = document.getElementById('detailCategory');
    const detailBatch = document.getElementById('detailBatch');
    const detailQty = document.getElementById('detailQty');
    const detailStatus = document.getElementById('detailStatus');
    const viewFullBtn = document.getElementById('viewFullBtn');

    function onDetailsClick(e){
      const idx = Number(this.dataset.index);
      const data = loadInventory();
      const row = data[idx];
      if(!row) return;

      // Fill details (show exactly the selected fields)
      detailExpiry.textContent = formatExpiryForDisplay(row['Expiry Date'] ?? row['Expiry'] ?? row['expiry'] ?? '');
      detailName.textContent = row['Medicine Name'] ?? row['name'] ?? '';
      detailCategory.textContent = row['Category'] ?? row['category'] ?? '';
      detailBatch.textContent = row['Batch No.'] ?? row['Batch'] ?? row['batch'] ?? '';
      detailQty.textContent = String(row['Qty'] ?? row['qty'] ?? row['Quantity'] ?? 0);
      detailStatus.textContent = computeStatusFromRow(row);

      // show overlay + panel
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden', 'false');

      // optional: view full (for now just scroll to row or alert - you said view-only; we keep a placeholder)
      viewFullBtn.onclick = function(){
        // If you later want to implement a full page, redirect here.
        // For now, just bring focus to the table row (small UX)
        const tr = document.querySelector(`#inventoryTable tbody tr[data-index="${idx}"]`);
        if(tr){
          tr.scrollIntoView({behavior:'smooth', block:'center'});
          tr.style.backgroundColor = '#fff8e5';
          setTimeout(()=> tr.style.backgroundColor = '', 1200);
        }
      };
    }

    // Close behavior
    closePanelBtn.addEventListener('click', ()=> {
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
    });
    // Clicking outside the panel (on overlay) closes too
    overlay.addEventListener('click', (ev)=>{
      if(ev.target === overlay){
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
      }
    });
    // Escape key to close
    window.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Escape' && overlay.classList.contains('show')){
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
      }
    });

    /********************
     Active menu highlighting
    ********************/
    (function highlightActive(){
      const current = window.location.pathname.split('/').pop() || 'inventory.html';
      document.querySelectorAll('.nav-list li').forEach(li=>{
        const a = li.querySelector('a');
        if(!a) return;
        const href = a.getAttribute('href');
        if(href === current) li.classList.add('active');
        else li.classList.remove('active');
      });
    })();

    /********************
     Init
    ********************/
    window.addEventListener('load', ()=>{
      refreshUI();
    });
  </script>
</body>
</html>
