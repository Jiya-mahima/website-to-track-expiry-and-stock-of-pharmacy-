<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pharmacy Inventory Management - Home</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* Minimal embedded styles so page looks consistent even without external css */
    :root{
      --sidebar-w:300px;
      --brand-dark:#0b214a;
      --muted:#f4f6f8;
      --card-bg:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--muted);color:#222}
    .sidebar { width: var(--sidebar-w); background-color: var(--brand-dark); color: white; position: fixed; top: 0; left: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; padding-top: 30px; z-index: 999; }
    .sidebar-header { display:flex; flex-direction:column; align-items:center; margin-bottom:25px; }
    .profile-pic { width:90px; height:90px; border-radius:50%; object-fit:cover; margin-bottom:12px; }
    .brand-name { font-size:20px; font-weight:bold; margin-bottom:25px; color:white; }
    .nav-list { list-style:none; padding:0; margin-top:10px; width:100%; }
    .nav-list li { width:100%; padding:14px 0; text-align:center; cursor:pointer; transition:.3s; border-radius:6px; }
    .nav-list li a { text-decoration:none; color:white; width:100%; display:block; }
    .nav-list li:hover { background-color:#19376d; }
    .nav-list li.active { background-color:#5d8ee9; }

    .main { margin-left: var(--sidebar-w); width: calc(100% - var(--sidebar-w)); min-height:100vh; display:flex; flex-direction:column; padding-bottom:40px; }
    .topbar{ position: sticky; top:0; z-index:50; background:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 1px 6px rgba(0,0,0,0.06); }
    .topbar h2{ color:var(--brand-dark); font-size:18px; margin:0 }

    .dashboard-wrapper{ padding:22px; }
    .cards{ display:flex; gap:18px; flex-wrap:wrap; }
    .card{ background:var(--card-bg); padding:18px; border-radius:10px; min-width:180px; box-shadow:0 6px 18px rgba(8,48,88,0.04); display:flex; flex-direction:column; gap:6px; }
    .card h3{ margin:0; font-size:14px; color:#555; }
    .card p{ margin:0; font-size:24px; font-weight:700; color:var(--brand-dark); }
    .muted{ color:#6b7280; font-size:13px; }
  </style>
</head>
<body>

<!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <img src="image/logo.jpg" alt="Pharmacy Logo" class="profile-pic">
      <h2 class="brand-name">PharmaTrack</h2>
    </div>

    <ul class="nav-list">
      <li class="active"><a href="home.html">Home</a></li>
      <li><a href="inventory.html">Inventory</a></li>
      <li><a href="add_medicine.html">Add Medicines</a></li>
      <li><a href="expiry.html">Expiry</a></li>
      <li><a href="profile.html">Profile</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="topbar">
      <h2>Pharmacy Inventory Management</h2>
    </div>

    <div class="dashboard-wrapper">
      <div class="dashboard-content">
        <div class="cards">
          <div class="card">
            <h3>Total Items</h3>
            <p id="totalItems">0</p>
            <div class="muted">Total medicine rows in inventory</div>
          </div>
          <div class="card">
            <h3>Expiring Soon (90 days)</h3>
            <p id="expiringSoon">0</p>
            <div class="muted">Items whose expiry falls within 90 days</div>
          </div>
          <div class="card">
            <h3>Low Stock Items (&lt; 10)</h3>
            <p id="lowStock">0</p>
            <div class="muted">Items with quantity &lt; 10</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  home.html parser for stored full-table HTML in localStorage key "medicineStock"

  Expectations (based on your earlier message):
  - localStorage.getItem('medicineStock') contains the whole table HTML (option B),
    i.e. "<table>...<tr>...</tr><tr>...</tr>...</table>" or similar.
  - Each row (tr) has td columns in exact order:
    [ 0 ] Medicine Name
    [ 1 ] Batch No
    [ 2 ] Category
    [ 3 ] Qty
    [ 4 ] Expiry Date  (formats: MM/YYYY, DD/MM/YYYY, YYYY-MM, YYYY-MM-DD etc.)
    [ 5 ] Status

  This script:
  - Reads the stored HTML
  - Extracts <tr> rows and parses <td> textContent
  - Converts expiry to Date (handles many formats)
  - Computes stats and updates dashboard
*/

const STORAGE_KEY = 'medicineStock';   // the key you provided
const LOW_STOCK_THRESHOLD = 10;
const EXPIRING_DAYS = 90;

// Utility: parse expiry strings into a Date object.
// Rules:
//  - MM/YYYY  -> last day of that month (treat as end of month)
//  - YYYY-MM  -> last day of that month (common from input[type="month"])
//  - DD/MM/YYYY -> exact day
//  - YYYY-MM-DD -> exact day
//  - If parse fails, return null
function parseExpiryToDate(str){
  if(!str && str !== 0) return null;
  str = String(str).trim();
  if(!str) return null;

  // MM/YYYY  or M/YYYY
  let mmyyyy = str.match(/^(\d{1,2})[\/\-](\d{4})$/);
  if(mmyyyy){
    const m = Number(mmyyyy[1]);
    const y = Number(mmyyyy[2]);
    // last day of month: new Date(y, m, 0)
    return new Date(y, m, 0, 23, 59, 59);
  }

  // YYYY-MM  (e.g., 2025-06) -> last day of month
  let yyyy_mm = str.match(/^(\d{4})-(\d{1,2})$/);
  if(yyyy_mm){
    const y = Number(yyyy_mm[1]);
    const m = Number(yyyy_mm[2]);
    return new Date(y, m, 0, 23,59,59);
  }

  // DD/MM/YYYY or D/M/YYYY
  let ddmmyyyy = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(ddmmyyyy){
    const d = Number(ddmmyyyy[1]);
    const m = Number(ddmmyyyy[2]);
    const y = Number(ddmmyyyy[3]);
    return new Date(y, m-1, d, 23,59,59);
  }

  // YYYY-MM-DD or ISO-ish -> try Date parse
  const isoTry = new Date(str);
  if(!isNaN(isoTry)) return isoTry;

  // fallback: try replacing dots with dashes
  const alt = str.replace(/\./g,'-');
  const altTry = new Date(alt);
  if(!isNaN(altTry)) return altTry;

  return null;
}

// days between two dates (from -> to)
function daysBetween(from, to){
  return Math.ceil((to - from) / (1000*60*60*24));
}

// Load the stored table HTML and return array of objects
function loadRowsFromMedicineStock(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return [];  // nothing stored

  // Create a container element and set innerHTML to parse DOM
  const container = document.createElement('div');

  // The stored string might sometimes be an array JSON of rows; handle both.
  try {
    // If raw is JSON array of strings: join them into one HTML string
    if(raw.trim().startsWith('[')){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)){
        // If each element looks like "<tr>...</tr>" join them
        const joined = parsed.join('');
        container.innerHTML = joined;
      } else {
        container.innerHTML = String(raw);
      }
    } else {
      // raw is probably a full table HTML string or similar
      container.innerHTML = raw;
    }
  } catch(e){
    // if JSON.parse failed, assume raw is raw HTML
    container.innerHTML = raw;
  }

  // Find all tr elements in the container. This will match rows whether the raw contains <table> or only rows.
  const trList = container.querySelectorAll('tr');
  const rows = [];

  trList.forEach(tr => {
    const tds = tr.querySelectorAll('td');
    // Only process rows with at least 5 tds (expected shape)
    if(tds.length >= 5){
      const name = tds[0].textContent.trim();
      const batch = tds[1].textContent.trim();
      const category = tds[2].textContent.trim();
      const qtyRaw = tds[3].textContent.trim();
      const expiryRaw = tds[4].textContent.trim();
      const status = (tds[5] ? tds[5].textContent.trim() : '');

      // normalize quantity to number
      const qty = Number(qtyRaw === '' ? 0 : qtyRaw.replace(/[^0-9.-]/g,''));
      rows.push({
        name: name || '—',
        batch: batch || '—',
        category: category || '—',
        qty: Number.isFinite(qty) ? qty : 0,
        expiryRaw: expiryRaw || '',
        status: status || ''
      });
    }
  });

  return rows;
}

// Compute stats: total items, expiringSoon, lowStock
function computeStatsFromRows(rows){
  const now = new Date();
  let total = 0, expiring = 0, low = 0;

  rows.forEach(r => {
    total++;
    if(!isNaN(r.qty) && r.qty < LOW_STOCK_THRESHOLD) low++;

    const d = parseExpiryToDate(r.expiryRaw);
    if(d){
      const diff = daysBetween(now, d);
      if(diff >= 0 && diff <= EXPIRING_DAYS) expiring++;
    }
  });

  return { total, expiring, low };
}

// Render stats to the DOM
function renderStats(){
  const rows = loadRowsFromMedicineStock();
  const stats = computeStatsFromRows(rows);

  document.getElementById('totalItems').textContent = stats.total;
  document.getElementById('expiringSoon').textContent = stats.expiring;
  document.getElementById('lowStock').textContent = stats.low;
}

// Watch for localStorage changes (other tab) and update
window.addEventListener('storage', (e) => {
  if(e.key === STORAGE_KEY) renderStats();
});

// Initial render on load
window.addEventListener('load', () => {
  renderStats();
});

// Optional: poll periodically in case the same tab updates localStorage via scripts that don't trigger "storage"
setInterval(renderStats, 3000);

</script>
</body>
</html>
